const excelJS = require("exceljs");
const workbook = new excelJS.Workbook();
const gerarPlanilha = require("../Exportacao/geraPlanilha");
const mongoose = require("mongoose");

const gerarModelo = async (req, res) => {
  
  for(element of workbook._worksheets){
    workbook.removeWorksheet(element);
  }

  const rota = req.body.table;  
  let table = "";
  let schema = {};

  table = rota == 'aereo' || rota == 'transporte' || rota == 'hotel' ? 'participantes' : rota;
  var modelo = mongoose.model(table);
  schema = modelo.schema.obj;

  schema = rota == 'aereo' ? schema.aereo[0] : schema;
  schema = rota == 'transporte' ? schema.transporte[0] : schema;
  schema = rota == 'hotel' ? schema.hotel[0] : schema;

  if(rota == 'participantes'){
    delete schema.aereo
    delete schema.transporte 
    delete schema.hotel 
    delete schema.historico 
  }
  
  header = [];
  const result = [];

  for (let key in schema) {
    if (Array.isArray(schema[key])) {
      for (let key2 in schema[key]) {
        header2 = [];
        if(rota == 'aereo' || rota == 'transporte' || rota == 'hotel' || key == 'servicos'){
          header2.unshift('codigo_participante')
        }
        //header2.push(`code_${rota}`);
        for(let key3 in schema[key][0]){
          header2.push(key3);  
        }              
        gerarPlanilha(workbook, header2, result, key);
      }

    } else {
      header.push(key)
    }
  }  

  if(rota == 'aereo' || rota == 'transporte' || rota == 'hotel'){
    header.unshift('codigo_participante')
  }
   gerarPlanilha(workbook, header, result, rota);

const data = await workbook.xlsx.writeBuffer(); // grava cloud temp

return data
};
module.exports = gerarModelo;
